<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>VeloDrive</title>

  <!-- SVG primary favicon -->
  <link rel="icon" type="image/svg+xml" href="icons/logo_sq.svg">

  <!-- PNG fallbacks -->
  <link rel="icon" type="image/png" sizes="16x16" href="icons/icon16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="icons/icon32.png">
  <link rel="icon" type="image/png" sizes="48x48" href="icons/icon48.png">
  <link rel="icon" type="image/png" sizes="128x128" href="icons/icon128.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icons/icon512.png">

  <!-- PWA Manifest -->
  <link rel="manifest" href="velodrive.webmanifest">

  <!-- Dynamic theme colors -->
  <meta name="theme-color" content="#f4f4f4" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#222222" media="(prefers-color-scheme: dark)">

  <link rel="stylesheet" href="workout-base.css">
  <link rel="stylesheet" href="workout-picker.css">
  <link rel="stylesheet" href="settings.css">
  <link rel="stylesheet" href="welcome.css">
</head>

<body class="welcome-active">
  <!-- Welcome / first-run tour overlay (placed first to avoid flash of content) -->
  <div id="welcomeOverlay" class="welcome-overlay" aria-modal="true" role="dialog" aria-label="Welcome intro">
    <div class="welcome-shell">
      <button id="welcomeCloseBtn" class="welcome-close-btn" type="button" aria-label="Skip intro">
        ×
      </button>

      <div class="welcome-slide">
        <header class="welcome-header">
          <h1 id="welcomeTitle" class="welcome-title"></h1>
        </header>

        <main class="welcome-main">
          <button id="welcomePrevBtn" class="welcome-nav welcome-nav-prev" type="button" aria-label="Previous">
            <span>❮</span>
          </button>

          <div class="welcome-video-wrapper">
            <video id="welcomeVideo" class="welcome-video" muted loop playsinline preload="auto"></video>

            <!-- Splash logo (first slide) -->
            <img id="welcomeLogo" class="welcome-logo" src="icons/logo_sq.svg" alt="VeloDrive logo" />
          </div>

          <button id="welcomeNextBtn" class="welcome-nav welcome-nav-next" type="button" aria-label="Next">
            <span>❯</span>
          </button>
        </main>

        <p id="welcomeBody" class="welcome-body"></p>
      </div>
    </div>
  </div>

  <div class="page-root">
    <section class="top-panel" aria-label="Workout stats">
      <div class="stat-card" data-key="power">
        <div class="stat-label">Power</div>
        <div class="stat-value"><span id="stat-power">--</span></div>
      </div>
      <div class="stat-card" data-key="intervalTime">
        <div class="stat-label">Interval Time</div>
        <div class="stat-value stat-lg"><span id="stat-interval-time">00:00</span></div>
      </div>
      <div class="stat-card" data-key="heartRate">
        <div class="stat-label">Heart Rate</div>
        <div class="stat-value"><span id="stat-hr">--</span></div>
      </div>
      <div class="stat-card" data-key="targetPower">
        <div class="stat-label">Target Power</div>
        <div class="stat-value"><span id="stat-target-power">--</span></div>
      </div>
      <div class="stat-card" data-key="elapsedTime">
        <div class="stat-label">Workout Time</div>
        <div class="stat-value stat-lg"><span id="stat-elapsed-time">00:00:00</span></div>
      </div>
      <div class="stat-card" data-key="cadence">
        <div class="stat-label">Cadence</div>
        <div class="stat-value"><span id="stat-cadence">--</span></div>
      </div>
    </section>

    <section id="chartPanel" class="chart-panel" aria-label="Workout profile and live data">
      <div id="chartEmptyOverlay" class="chart-empty-state" style="display:none">
        <div id="chartEmptyMessage" class="chart-empty-message">
          Connect your bike
        </div>

        <!-- Single arrow SVG; JS just flips it left/right -->
        <svg id="chartEmptyArrow" class="chart-empty-arrow chart-empty-arrow--left" viewBox="0 0 52.916665 52.916666"
          preserveAspectRatio="none" aria-hidden="true">
          <g>
            <path class="chart-empty-arrow-main" d="M 51.472993,14.207927
         C 46.120999,17.671066 40.269075,17.583209 34.622628,17.157855
           29.288422,16.788704 23.874176,16.262741 18.609072,18.089194
           14.872863,19.770591 12.035953,24.626821 9.8229085,29.694766
           7.5506784,35.257104 6.0236691,40.53837 4.6810022,46.394288" />

            <path class="chart-empty-arrow-main" d="m 2.9466055,41.671853
         c 0.066234,0.595617 0.2291127,1.842722 0.2430367,2.548134
           0.1721301,1.129681 -0.047682,2.299663 0.8821012,3.521698
           1.0543304,-0.189198 1.9004822,-1.093461 2.8846226,-1.547496
           0.804207,-0.437777 0.8540386,-0.58115 1.6908182,-0.913426" />
          </g>
        </svg>
      </div>

      <svg id="chartSvg" viewBox="0 0 1000 400" preserveAspectRatio="none"></svg>
      <div id="chartTooltip" class="chart-tooltip"></div>
    </section>


  </div>

  <!-- Bottom nav -->
  <nav class="bottom-nav">
    <div class="nav-left">
      <!-- Bike / trainer status -->
      <button class="device-group" id="bikeConnectBtn">
        <div class="icon-box">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path
              d="M5 16.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zm0 0 3-6h4l3 6m-4-6 1.5-3M16 7h-3m7 9.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5z" />
          </svg>
          <div id="bikeStatusDot" class="status-dot"></div>
        </div>
        <div class="device-label">
          <span>Bike</span>
        </div>
      </button>

      <!-- HR status -->
      <button class="device-group" id="hrConnectBtn">
        <div class="icon-box">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path
              d="M12 20s-4.5-2.9-7-6.1C3.2 12.1 3 10.8 3 9.9 3 7.8 4.7 6 6.9 6c1.3 0 2.6.6 3.4 1.8C11.5 6.6 12.8 6 14.1 6 16.3 6 18 7.8 18 9.9c0 .9-.2 2.2-2 4-2.5 3.2-7 6.1-7 6.1z" />
          </svg>
          <div id="hrStatusDot" class="status-dot"></div>
        </div>
        <div class="device-label">
          <span>HRM</span>
          <span id="hrBatteryLabel" class="device-battery"></span>
        </div>
      </button>

      <!-- Settings (immediately right of HR) -->
      <button id="settingsBtn" class="nav-icon-button" title="Settings">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path
            d="M19.14 12.94c.04-.31.06-.63.06-.94s-.02-.63-.06-.94l2.03-1.58a.5.5 0 0 0 .12-.64l-1.92-3.32a.5.5 0 0 0-.61-.22l-2.39.96a7.007 7.007 0 0 0-1.63-.94l-.36-2.54A.5.5 0 0 0 14.5 2h-4a.5.5 0 0 0-.49.42l-.36 2.54c-.59.24-1.13.55-1.63.94l-2.39-.96a.5.5 0 0 0-.61.22L3.1 8.84a.5.5 0 0 0 .12.64l2.03 1.58c-.04.31-.06.65-.06.94 0 .32.02.63.06.94l-2.03 1.58a.5.5 0 0 0-.12.64l1.92 3.32c.14.24.43.34.68.24l2.39-.96c.5.39 1.04.7 1.63.94l.36 2.54c.05.24.25.42.49.42h4c.24 0 .44-.18.49-.42l.36-2.54c.59-.24 1.13-.55 1.63-.94l2.39.96c.25.1.54 0 .68-.24l1.92-3.32a.5.5 0 0 0-.12-.64l-2.03-1.58zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z" />
        </svg>
      </button>
    </div>

    <div class="mode-toggle-wrapper">
      <div class="mode-toggle-inner">
        <!-- Mode toggle (shown when no workout is running) -->
        <div id="modeToggle" class="mode-toggle" title="Control mode">
          <button class="mode-toggle-button active" data-mode="workout" title="Change to workout mode (W)">Workout</button>
          <button class="mode-toggle-button" data-mode="erg" title="Change to erg mode (E)">ERG</button>
          <button class="mode-toggle-button" data-mode="resistance" title="Change to resistance mode (R)">Resistance</button>
        </div>

        <!-- Center workout title (shown when workout is running) -->
        <div id="workoutTitleCenter" class="workout-title-center" style="display:none" title="">
          <!-- text filled by JS -->
        </div>
      </div>
    </div>

    <div class="nav-right">
      <!-- Manual controls for ERG / Resistance -->
      <div id="manualControls" class="control-group" style="display:none">
        <button class="control-btn" data-delta="-10">-</button>
        <div class="control-value">
          <!-- Reuse the FTP input styling -->
          <input id="manualInput" class="settings-ftp-input" type="number" inputmode="numeric" />
          <span id="manualUnit" class="settings-ftp-unit"></span>
        </div>
        <button class="control-btn" data-delta="10">+</button>
      </div>


      <!-- Workout controls: FTP + title + playback -->
      <div id="workoutControls" class="workout-controls">

        <div id="workoutNameLabel" class="inline-clicktoggle">
          Selected workout
        </div>

        <!-- START button -->
        <button id="startBtn" class="playback-button" title="Start workout (Space)">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M9 7v10l8-5z" />
          </svg>
        </button>

        <!-- PLAY button (for resume) -->
        <button id="playBtn" class="playback-button" title="Resume workout">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M9 7v10l8-5z" />
          </svg>
        </button>

        <!-- PAUSE button -->
        <button id="pauseBtn" class="playback-button" title="Pause workout">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M9 7v10M15 7v10" />
          </svg>
        </button>

        <!-- STOP button -->
        <button id="stopBtn" class="playback-button" title="End workout">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <rect x="8" y="8" width="8" height="8" />
          </svg>
        </button>
      </div>

    </div>
  </nav>

  <!-- Workout picker overlay -->
  <div id="workoutPickerOverlay" class="workout-picker-overlay" aria-modal="true" role="dialog">
    <div id="workoutPickerModal" class="workout-picker-modal">

      <header class="workout-picker-header">
        <div class="workout-picker-header-main">
          <div class="workout-picker-title" id="workoutPickerTitle">
            Workout library
          </div>
        </div>

        <div class="workout-picker-controls">
          <input id="pickerSearchInput" type="search" placeholder="Search name, source, text…" />
          <select id="pickerZoneFilter">
            <option value="">All zones</option>
            <option value="Recovery">Recovery</option>
            <option value="Endurance">Endurance</option>
            <option value="Tempo">Tempo</option>
            <option value="Threshold">Threshold</option>
            <option value="VO2Max">VO2Max</option>
            <option value="HIIT">HIIT</option>
          </select>
          <select id="pickerDurationFilter">
            <option value="">All durations</option>
            <option value="0-30">0–30 min</option>
            <option value="30-60">30–60 min</option>
            <option value="60-90">60–90 min</option>
            <option value="90-120">90–120 min</option>
            <option value="120-150">120–150 min</option>
            <option value="150-180">150–180 min</option>
            <option value="180-210">180–210 min</option>
            <option value="210-240">210–240 min</option>
            <option value=">240">&gt; 4 hours</option>
          </select>

          <button id="pickerAddWorkoutBtn" class="picker-add-btn" type="button">
            <svg viewBox="0 0 24 24" class="wb-code-icon" aria-hidden="true">
              <path d="M12 5v14M5 12h14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            </svg>
            <span>Add workout</span>
          </button>

          <div id="workoutBuilderStatus" class="builder-status" style="display:none;"></div>

          <button id="workoutBuilderBackBtn" class="wb-code-insert-btn picker-back-btn" type="button"
            style="display:none;">
            <svg viewBox="0 0 24 24" aria-hidden="true" style="width:16px;height:16px;display:block;stroke-width:1.6;"
              class="wb-code-icon">
              <path d="M15 6l-6 6 6 6" fill="none" stroke="currentColor" stroke-linecap="round"
                stroke-linejoin="round" />
            </svg>
            <span>Back To Library</span>
          </button>
          <button id="workoutBuilderSaveBtn" class="picker-add-btn picker-save-btn" type="button" style="display:none;"
            title="Save workout to library">

            <svg viewBox="0 0 24 24" aria-hidden="true" style="width:16px;height:16px;display:block;"
              class="wb-code-icon">
              <!-- Modern floppy disk style using only currentColor -->
              <path fill="none" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"
                d="M4 3h13l3 3v15H4z" />
              <path fill="none" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round" d="M8 3v6h8V3" />
              <rect x="7" y="15" width="10" height="5" rx="1" fill="none" stroke="currentColor" stroke-width="1.8" />
            </svg>

            <span>Save</span>
          </button>

          <button id="workoutPickerCloseBtn" class="picker-close-btn" title="Close">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M6 6l12 12M18 6L6 18" />
            </svg>
          </button>
        </div>

      </header>

      <div id="workoutImportRoot" class="workout-import-root" style="display:none;"></div>
      <div id="workoutBuilderRoot" class="workout-builder-root" style="display:none;"></div>

      <div class="workout-picker-table-wrapper">
        <div id="pickerEmptyState" class="picker-empty-state" style="display:none;">
          <div class="picker-empty-message">
            No workouts found. Add your first workout.
          </div>
          <button id="pickerEmptyAddBtn" type="button" class="picker-empty-add-btn">
            + Add workout
          </button>
        </div>

        <table class="workout-picker-table">
          <thead>
            <tr>
              <th data-sort-key="name">Name</th>
              <th>Zone</th>
              <th>Source</th>
              <th data-sort-key="if">IF</th>
              <th data-sort-key="tss">TSS</th>
              <th data-sort-key="duration">Duration</th>
              <th data-sort-key="kjAdj">kJ</th>
            </tr>
          </thead>
          <tbody id="pickerWorkoutTbody">
            <!-- rows injected by JS -->
          </tbody>
        </table>
      </div>

      <div class="picker-footer">
        <span>
          Hotkeys:
          <strong>j / k</strong> or <strong>↑ / ↓</strong> to move between rows.
        </span>
        <span id="pickerSummary" class="workout-picker-summary"></span>
      </div>

    </div>
  </div>

  <!-- Settings overlay -->
  <div id="settingsOverlay" class="settings-overlay" aria-modal="true" role="dialog">
    <div id="settingsModal" class="settings-modal" tabindex="-1">
      <header class="settings-header">
        <div class="settings-header-main">
          <div id="settingsTitle" class="settings-title">Settings</div>
        </div>

        <div class="settings-header-actions">
          <button id="settingsBackFromLogsBtn" class="settings-button" type="button" style="display: none;">
            <svg viewBox="0 0 24 24" aria-hidden="true"
              style="width: 18px; height: 18px; display: block; stroke-width: 1.8;">
              <path d="M15 6l-6 6 6 6" fill="none" stroke="currentColor" stroke-linecap="round"
                stroke-linejoin="round" />
            </svg>
            <span>Back to settings</span>
          </button>

          <button id="settingsCloseBtn" class="settings-close-btn" title="Close settings">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M6 6l12 12M18 6L6 18" />
            </svg>
          </button>
        </div>
      </header>


      <div class="settings-body">
        <!-- Main settings view -->
        <div id="settingsMainView" class="settings-main-view">
          <div class="settings-list">
            <div class="settings-row">
              <div class="settings-row-main">
                <div class="settings-icon">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M4 5h6l2 2h8v12H4z" />
                  </svg>
                </div>
                <div class="settings-row-text">
                  <div class="settings-row-label">
                    VeloDrive folder
                    <button class="settings-help-toggle-btn" type="button" data-settings-help-toggle="settingsFoldersHelp">
                      Help
                    </button>
                  </div>
                  <div class="settings-row-description">
                    Workouts, history, and trash live in one folder you pick.
                  </div>
                </div>
              </div>
              <div class="settings-row-right">
                <div class="settings-inline-group">
                  <div class="settings-row-status" id="rootDirStatus"></div>
                  <button id="rootDirButton" class="settings-button" type="button">
                    Choose…
                  </button>
                </div>
              </div>
            </div>

            <div id="settingsFoldersHelp" class="settings-help-content" hidden>
              Pick a home base for VeloDrive (for example <code>~/VeloDrive</code>). We’ll use that one spot
              to store everything and you can reselect it later if you move devices.
            </div>

            <div class="settings-row">
              <div class="settings-row-main">
                <div class="settings-icon">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M11 21L5 13h4V3l8 8h-4v10z" />
                  </svg>
                </div>
                <div class="settings-row-text">
                  <div class="settings-row-label">
                    FTP
                    <button class="settings-help-toggle-btn" type="button" data-settings-help-toggle="settingsFtpHelp">
                      What’s this?
                    </button>
                  </div>
                  <div class="settings-row-description">
                    Tweak difficulty if workouts feel too easy or hard.
                  </div>
                </div>
              </div>
              <div class="settings-row-right">
                <div id="settingsFtpControls" class="control-group">
                  <button class="control-btn" type="button" data-ftp-delta="-10">-</button>
                  <div class="control-value">
                    <input id="settingsFtpInput" class="settings-ftp-input" type="number" min="50" max="500" step="1"
                      inputmode="numeric" />
                    <span class="settings-ftp-unit">W</span>
                  </div>
                  <button class="control-btn" type="button" data-ftp-delta="10">+</button>
                </div>
              </div>
            </div>

            <div id="settingsFtpHelp" class="settings-help-content" hidden>
              FTP is the power you can hold for about an hour. If you do not know it, multiply your weight in kg by 3
              for a quick starting point.
            </div>

            <div class="settings-row" id="settingsSoundToggle">
              <div class="settings-row-main">
                <div class="settings-icon">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M5 10v4h3l4 4V6l-4 4H5z" />
                    <path d="M15 9.5c1 .7 1.6 1.9 1.6 3.1 0 1.2-.6 2.4-1.6 3.1" />
                  </svg>
                </div>
                <div class="settings-row-text">
                  <div class="settings-row-label">
                    Sounds
                    <button class="settings-help-toggle-btn" type="button"
                      data-settings-help-toggle="settingsSoundHelp">
                      What will I hear?
                    </button>
                  </div>
                  <div class="settings-row-description">
                    Interval beeps and the start countdown.
                  </div>
                </div>
              </div>
              <div class="settings-row-right">
                <label class="settings-toggle-switch">
                  <input id="settingsSoundCheckbox" type="checkbox" />
                  <span class="settings-toggle-slider"></span>
                </label>
              </div>
            </div>

            <div id="settingsSoundHelp" class="settings-help-content" hidden>
              A short beep before interval changes, a stronger cue before big efforts, and a quick countdown when you
              hit start.
            </div>

            <div class="settings-row">
              <div class="settings-row-main">
                <div class="settings-icon">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 3v18l5-5-3.5-4L17 8l-5-5z" />
                    <path d="M7 8l5 4-5 4" />
                  </svg>
                </div>
                <div class="settings-row-text">
                  <div class="settings-row-label">
                    Bluetooth
                    <button class="settings-help-toggle-btn" type="button" data-settings-help-toggle="settingsEnvHelp">
                      Details
                    </button>
                  </div>
                  <div class="settings-row-description">Web Bluetooth support for trainer and HR pairing.</div>
                </div>
              </div>
              <div class="settings-row-right">
                <div id="settingsBtStatusText" class="settings-row-status"></div>
              </div>
            </div>

            <div id="settingsEnvHelp" class="settings-help-content" hidden>
              Web Bluetooth is supported only in Google Chrome. If devices will not show up, copy/paste these addresses
              into Chrome, set them to Enabled, restart, and try again:
              <ul style="margin:6px 0 0 18px; padding-left:0;">
                <li><code>chrome://flags/#enable-web-bluetooth</code> → Enabled</li>
                <li><code>chrome://flags/#enable-web-bluetooth-new-permissions-backend</code> → Enabled</li>
              </ul>
            </div>

            <div class="settings-row">
              <div class="settings-row-main">
                <div class="settings-icon">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M5 5h14M5 9h10M5 13h14M5 17h8" />
                  </svg>
                </div>
                <div class="settings-row-text">
                  <div class="settings-row-label">
                    Connection logs
                  </div>
                  <div class="settings-row-description">Live Bluetooth and device messages.</div>
                </div>
              </div>
              <div class="settings-row-right">
                <button id="settingsOpenLogsBtn" class="settings-button" type="button">
                  View logs
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Logs view -->
        <div id="settingsLogsView" class="settings-logs-view">
          <div id="settingsLogsContent" class="settings-logs-body"></div>
        </div>
      </div>
    </div>
  </div>


  <!-- Status overlay (3-2-1 / paused / resumed) -->
  <div id="statusOverlay" class="status-overlay">
    <div id="statusText"></div>
  </div>

  <script type="module" src="workout.js"></script>
</body>

</html>
